generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Alert {
  id        String    @id
  userId    String
  type      AlertType
  title     String
  message   String
  metadata  Json?
  isRead    Boolean   @default(false)
  isSent    Boolean   @default(false)
  createdAt DateTime  @default(now())
  User      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([isRead])
  @@index([isSent])
  @@index([userId])
}

model Attachment {
  id            String       @id
  userId        String
  fileName      String
  fileUrl       String
  fileSize      BigInt
  mimeType      String
  expenseId     String?
  revenueId     String?
  maintenanceId String?
  metadata      Json?
  createdAt     DateTime     @default(now())
  Expense       Expense?     @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  Maintenance   Maintenance? @relation(fields: [maintenanceId], references: [id], onDelete: Cascade)
  Revenue       Revenue?     @relation(fields: [revenueId], references: [id], onDelete: Cascade)
  User          User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expenseId])
  @@index([maintenanceId])
  @@index([revenueId])
  @@index([userId])
}

model Budget {
  id             String      @id
  userId         String
  name           String?
  expenseTypeId  String
  monthlyLimit   Float
  alertThreshold Float       @default(0.8)
  period         String
  isActive       Boolean     @default(true)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime
  ExpenseType    ExpenseType @relation(fields: [expenseTypeId], references: [id], onDelete: Cascade)
  User           User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expenseTypeId])
  @@index([period])
  @@index([userId])
  @@index([userId, isActive, period, expenseTypeId])
}

model Driver {
  id              String            @id
  name            String
  userId          String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  isSelf          Boolean           @default(false)
  User            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  Expense         Expense[]
  ExpenseTemplate ExpenseTemplate[]
  Goal            Goal[]
  Revenue         Revenue[]
  UserPreferences UserPreferences[]
  WorkLog         WorkLog[]

  @@index([userId])
  @@index([userId, isSelf])
}

model EmailVerificationCode {
  id        String   @id
  code      String
  userId    String
  email     String
  expiresAt DateTime
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Expense {
  id                 String               @id
  amount             Float
  date               DateTime
  receiptUrl         String?
  driverId           String?
  vehicleId          String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  Attachment         Attachment[]
  Driver             Driver?              @relation(fields: [driverId], references: [id])
  Vehicle            Vehicle?             @relation(fields: [vehicleId], references: [id])
  ExpenseExpenseType ExpenseExpenseType[]

  @@index([date, driverId, vehicleId])
  @@index([date])
  @@index([driverId, date])
  @@index([driverId])
  @@index([vehicleId, date])
  @@index([vehicleId])
}

model ExpenseExpenseType {
  id            String      @id
  expenseId     String
  expenseTypeId String
  createdAt     DateTime    @default(now())
  Expense       Expense     @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  ExpenseType   ExpenseType @relation(fields: [expenseTypeId], references: [id], onDelete: Cascade)

  @@unique([expenseId, expenseTypeId])
  @@index([expenseId])
  @@index([expenseTypeId, expenseId])
  @@index([expenseTypeId])
}

model ExpenseTemplate {
  id            String               @id
  userId        String
  name          String
  amount        Float?
  expenseTypeId String
  driverId      String?
  vehicleId     String?
  isRecurring   Boolean              @default(false)
  frequency     RecurrenceFrequency?
  nextDueDate   DateTime?
  isActive      Boolean              @default(true)
  createdAt     DateTime             @default(now())
  updatedAt     DateTime
  Driver        Driver?              @relation(fields: [driverId], references: [id])
  ExpenseType   ExpenseType          @relation(fields: [expenseTypeId], references: [id], onDelete: Cascade)
  User          User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  Vehicle       Vehicle?             @relation(fields: [vehicleId], references: [id])

  @@index([userId, isActive])
  @@index([userId, isRecurring, nextDueDate])
}

model ExpenseType {
  id                 String               @id
  name               String
  userId             String
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  Budget             Budget[]
  ExpenseExpenseType ExpenseExpenseType[]
  ExpenseTemplate    ExpenseTemplate[]
  User               User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  Reminder           Reminder[]

  @@index([userId])
}

model Goal {
  id          String   @id
  userId      String
  name        String?
  type        GoalType
  targetValue Float
  period      String
  driverId    String?
  vehicleId   String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  Driver      Driver?  @relation(fields: [driverId], references: [id])
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  Vehicle     Vehicle? @relation(fields: [vehicleId], references: [id])

  @@index([driverId])
  @@index([period])
  @@index([userId])
  @@index([userId, isActive, period])
  @@index([vehicleId])
}

model Insight {
  id          String      @id
  userId      String
  type        InsightType
  title       String
  description String
  metadata    Json?
  isRead      Boolean     @default(false)
  priority    Int         @default(0)
  createdAt   DateTime    @default(now())
  User        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([isRead])
  @@index([userId])
}

model Maintenance {
  id            String       @id
  description   String
  cost          Float
  date          DateTime
  kmAtService   Float?
  nextServiceKm Float?
  receiptUrl    String?
  vehicleId     String
  createdAt     DateTime     @default(now())
  updatedAt     DateTime
  Attachment    Attachment[]
  Vehicle       Vehicle      @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([vehicleId])
}

model Partner {
  id           String          @id
  name         String
  category     PartnerCategory
  logoUrl      String?
  discountRate Float?
  tagline      String
  benefit      String
  ctaText      String
  ctaUrl       String
  showForPlans PlanType[]
  active       Boolean         @default(true)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime

  @@index([active])
  @@index([category])
}

model PaymentMethod {
  id            String    @id
  name          String
  userId        String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime
  feeFixed      Float?
  feePercentage Float?
  feeType       FeeType   @default(NONE)
  User          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  Revenue       Revenue[]

  @@index([userId])
}

model Platform {
  id              String            @id
  name            String
  userId          String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  User            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  RevenuePlatform RevenuePlatform[]

  @@index([userId])
}

model Reminder {
  id            String            @id
  userId        String
  title         String
  description   String?
  frequency     ReminderFrequency
  nextDate      DateTime
  expenseTypeId String?
  isActive      Boolean           @default(true)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime
  ExpenseType   ExpenseType?      @relation(fields: [expenseTypeId], references: [id])
  User          User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([isActive])
  @@index([nextDate])
  @@index([userId])
}

model Report {
  id        String     @id
  userId    String
  name      String
  type      ReportType
  format    String
  startDate DateTime
  endDate   DateTime
  fileUrl   String?
  metadata  Json?
  createdAt DateTime   @default(now())
  User      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([userId])
}

model Revenue {
  id              String            @id
  amount          Float
  date            DateTime
  kmDriven        Float?
  hoursWorked     Float?
  receiptUrl      String?
  paymentMethodId String?
  driverId        String?
  vehicleId       String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  Attachment      Attachment[]
  Driver          Driver?           @relation(fields: [driverId], references: [id])
  PaymentMethod   PaymentMethod?    @relation(fields: [paymentMethodId], references: [id])
  Vehicle         Vehicle?          @relation(fields: [vehicleId], references: [id])
  RevenuePlatform RevenuePlatform[]

  @@index([date, driverId])
  @@index([date, driverId, vehicleId])
  @@index([date])
  @@index([driverId, date])
  @@index([driverId])
  @@index([paymentMethodId, date])
  @@index([vehicleId, date])
  @@index([vehicleId])
}

model RevenuePlatform {
  id         String   @id
  revenueId  String
  platformId String
  createdAt  DateTime @default(now())
  Platform   Platform @relation(fields: [platformId], references: [id], onDelete: Cascade)
  Revenue    Revenue  @relation(fields: [revenueId], references: [id], onDelete: Cascade)

  @@unique([revenueId, platformId])
  @@index([platformId])
  @@index([platformId, revenueId])
  @@index([revenueId])
}

model Session {
  id        String   @id
  userId    String
  expiresAt DateTime
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model StripeWebhookEvent {
  id            String   @id
  stripeEventId String   @unique
  type          String
  processed     Boolean  @default(false)
  createdAt     DateTime @default(now())

  @@index([processed])
  @@index([stripeEventId])
}

model User {
  id                        String                  @id @unique
  name                      String?
  email                     String?                 @unique
  emailVerified             Boolean?                @default(false)
  picture                   String?
  stripe_customer_id        String?                 @unique
  stripe_subscription_id    String?                 @unique
  stripe_price_id           String?
  stripe_current_period_end DateTime?
  createdAt                 DateTime                @default(now())
  updatedAt                 DateTime
  exportCountResetAt        DateTime?
  monthlyExportCount        Int                     @default(0)
  planType                  PlanType                @default(FREE)
  storageUsed               BigInt                  @default(0)
  hasCompletedOnboarding    Boolean                 @default(false)
  Alert                     Alert[]
  Attachment                Attachment[]
  Budget                    Budget[]
  Driver                    Driver[]
  EmailVerificationCode     EmailVerificationCode[]
  ExpenseTemplate           ExpenseTemplate[]
  ExpenseType               ExpenseType[]
  Goal                      Goal[]
  Insight                   Insight[]
  PaymentMethod             PaymentMethod[]
  Platform                  Platform[]
  Reminder                  Reminder[]
  Report                    Report[]
  Session                   Session[]
  UserPreferences           UserPreferences?
  Vehicle                   Vehicle[]
}

model UserPreferences {
  id                 String   @id
  userId             String   @unique
  theme              String   @default("system")
  language           String   @default("en")
  currency           String   @default("brl")
  timezone           String   @default("America/Sao_Paulo")
  use24HourFormat    Boolean  @default(false)
  emailNotifications Boolean  @default(true)
  pushNotifications  Boolean  @default(false)
  marketingEmails    Boolean  @default(false)
  analytics          Boolean  @default(true)
  profileVisibility  Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime
  defaultDriverId    String?
  defaultVehicleId   String?
  fontFamily         String   @default("default")
  fontSize           String   @default("medium")
  highContrast       Boolean  @default(false)
  keyboardShortcuts  Json?
  lineSpacing        String   @default("normal")
  reducedMotion      Boolean  @default(false)
  Driver             Driver?  @relation(fields: [defaultDriverId], references: [id])
  Vehicle            Vehicle? @relation(fields: [defaultVehicleId], references: [id])
  User               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Vehicle {
  id              String            @id
  name            String
  plate           String?
  model           String?
  year            Int?
  userId          String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  isPrimary       Boolean           @default(false)
  Expense         Expense[]
  ExpenseTemplate ExpenseTemplate[]
  Goal            Goal[]
  Maintenance     Maintenance[]
  Revenue         Revenue[]
  UserPreferences UserPreferences[]
  User            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  WorkLog         WorkLog[]

  @@index([userId])
  @@index([userId, isPrimary])
}

model WorkLog {
  id          String   @id
  date        DateTime
  kmDriven    Float
  hoursWorked Float
  driverId    String?
  vehicleId   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  Driver      Driver?  @relation(fields: [driverId], references: [id])
  Vehicle     Vehicle? @relation(fields: [vehicleId], references: [id])

  @@index([date, driverId, vehicleId])
  @@index([date])
  @@index([driverId])
  @@index([vehicleId])
}

enum AlertType {
  BUDGET_WARNING
  BUDGET_EXCEEDED
  GOAL_PROGRESS
  MAINTENANCE_REMINDER
  EXPENSE_REMINDER
  REVENUE_REMINDER
  DAILY_LOG_REMINDER
}

enum FeeType {
  NONE
  PERCENTAGE
  FIXED
  BOTH
}

enum GoalType {
  DAILY_REVENUE
  WEEKLY_REVENUE
  MONTHLY_REVENUE
  MONTHLY_PROFIT
  MONTHLY_KM
  MONTHLY_HOURS
  CUSTOM
}

enum InsightType {
  COST_INCREASE
  COST_DECREASE
  REVENUE_INCREASE
  REVENUE_DECREASE
  EFFICIENCY_IMPROVED
  EFFICIENCY_DECLINED
  GOAL_ACHIEVED
  BUDGET_EXCEEDED
  MAINTENANCE_DUE
  PATTERN_DETECTED
}

enum PartnerCategory {
  FUEL
  MAINTENANCE
  INSURANCE
  PAYMENT
  PARKING
  TOLLS
  CAR_WASH
  TIRES
}

enum PlanType {
  FREE
  SIMPLE
  PRO
}

enum RecurrenceFrequency {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

enum ReminderFrequency {
  ONCE
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

enum ReportType {
  MONTHLY_SUMMARY
  DRE
  CARNE_LEAO
  EXPENSE_BREAKDOWN
  REVENUE_BREAKDOWN
  DRIVER_PERFORMANCE
  VEHICLE_PERFORMANCE
  CUSTOM
}
