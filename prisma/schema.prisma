generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Alert {
  id        String    @id @default(cuid())
  userId    String
  type      AlertType
  title     String
  message   String
  metadata  Json?
  isRead    Boolean   @default(false)
  isSent    Boolean   @default(false)
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([isRead])
  @@index([isSent])
  @@index([userId])
}

model Attachment {
  id            String       @id @default(cuid())
  userId        String
  fileName      String
  fileUrl       String
  fileSize      BigInt
  mimeType      String
  expenseId     String?
  revenueId     String?
  maintenanceId String?
  metadata      Json?
  createdAt     DateTime     @default(now())
  expense       Expense?     @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  maintenance   Maintenance? @relation(fields: [maintenanceId], references: [id], onDelete: Cascade)
  revenue       Revenue?     @relation(fields: [revenueId], references: [id], onDelete: Cascade)
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expenseId])
  @@index([maintenanceId])
  @@index([revenueId])
  @@index([userId])
}

model Budget {
  id             String      @id @default(cuid())
  userId         String
  name           String?
  expenseTypeId  String
  monthlyLimit   Float
  alertThreshold Float       @default(0.8)
  period         String
  isActive       Boolean     @default(true)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  expenseType    ExpenseType @relation(fields: [expenseTypeId], references: [id], onDelete: Cascade)
  user           User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expenseTypeId])
  @@index([period])
  @@index([userId])
  @@index([userId, isActive, period, expenseTypeId])
}

model Driver {
  id              String            @id @default(cuid())
  name            String
  userId          String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  isSelf          Boolean           @default(false)
  cnh             String?
  cpf             String?
  phone           String?
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  expenses        Expense[]
  expenseTemplates ExpenseTemplate[]
  goals           Goal[]
  revenues        Revenue[]
  userPreferences UserPreferences[]
  workLogs        WorkLog[]

  @@index([userId])
  @@index([userId, isSelf])
}

model EmailVerificationCode {
  id        String   @id @default(cuid())
  code      String
  userId    String
  email     String
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Expense {
  id                 String               @id @default(cuid())
  amount             Float
  date               DateTime
  receiptUrl         String?
  driverId           String?
  vehicleId          String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  attachments        Attachment[]
  driver             Driver?              @relation(fields: [driverId], references: [id])
  vehicle            Vehicle?             @relation(fields: [vehicleId], references: [id])
  expenseExpenseTypes ExpenseExpenseType[]

  @@index([date, driverId, vehicleId])
  @@index([date])
  @@index([driverId, date])
  @@index([driverId])
  @@index([vehicleId, date])
  @@index([vehicleId])
}

model ExpenseExpenseType {
  id            String      @id @default(cuid())
  expenseId     String
  expenseTypeId String
  createdAt     DateTime    @default(now())
  expense       Expense     @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  expenseType   ExpenseType @relation(fields: [expenseTypeId], references: [id], onDelete: Cascade)

  @@unique([expenseId, expenseTypeId])
  @@index([expenseId])
  @@index([expenseTypeId, expenseId])
  @@index([expenseTypeId])
}

model ExpenseTemplate {
  id            String               @id @default(cuid())
  userId        String
  name          String
  amount        Float?
  expenseTypeId String
  driverId      String?
  vehicleId     String?
  isRecurring   Boolean              @default(false)
  frequency     RecurrenceFrequency?
  nextDueDate   DateTime?
  isActive      Boolean              @default(true)
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  driver        Driver?              @relation(fields: [driverId], references: [id])
  expenseType   ExpenseType          @relation(fields: [expenseTypeId], references: [id], onDelete: Cascade)
  user          User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicle       Vehicle?             @relation(fields: [vehicleId], references: [id])

  @@index([userId, isActive])
  @@index([userId, isRecurring, nextDueDate])
}

model ExpenseType {
  id                 String               @id @default(cuid())
  name               String
  userId             String
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  budgets            Budget[]
  expenseExpenseTypes ExpenseExpenseType[]
  expenseTemplates    ExpenseTemplate[]
  user               User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  reminders          Reminder[]

  @@index([userId])
}

model Goal {
  id          String   @id @default(cuid())
  userId      String
  name        String?
  type        GoalType
  targetValue Float
  period      String
  driverId    String?
  vehicleId   String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  driver      Driver?  @relation(fields: [driverId], references: [id])
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicle     Vehicle? @relation(fields: [vehicleId], references: [id])

  @@index([driverId])
  @@index([period])
  @@index([userId])
  @@index([userId, isActive, period])
  @@index([vehicleId])
}

model Insight {
  id          String      @id @default(cuid())
  userId      String
  type        InsightType
  title       String
  description String
  metadata    Json?
  isRead      Boolean     @default(false)
  priority    Int         @default(0)
  createdAt   DateTime    @default(now())
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([isRead])
  @@index([userId])
}

model Maintenance {
  id            String       @id @default(cuid())
  description   String
  cost          Float
  date          DateTime
  kmAtService   Float?
  nextServiceKm Float?
  receiptUrl    String?
  vehicleId     String
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  attachments   Attachment[]
  vehicle       Vehicle      @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([vehicleId])
}

model Partner {
  id           String          @id @default(cuid())
  name         String
  category     PartnerCategory
  logoUrl      String?
  discountRate Float?
  tagline      String
  benefit      String
  ctaText      String
  ctaUrl       String
  showForPlans PlanType[]
  active       Boolean         @default(true)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  locales      String[]
  priority     Int             @default(0)

  @@index([active])
  @@index([category])
  @@index([priority])
}

model PaymentMethod {
  id            String    @id @default(cuid())
  name          String
  userId        String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  feeFixed      Float?
  feePercentage Float?
  feeType       FeeType   @default(NONE)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  revenues      Revenue[]

  @@index([userId])
}

model Platform {
  id              String            @id @default(cuid())
  name            String
  userId          String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  revenuePlatforms RevenuePlatform[]

  @@index([userId])
}

model Reminder {
  id            String            @id @default(cuid())
  userId        String
  title         String
  description   String?
  frequency     ReminderFrequency
  nextDate      DateTime
  expenseTypeId String?
  isActive      Boolean           @default(true)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  expenseType   ExpenseType?      @relation(fields: [expenseTypeId], references: [id])
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([isActive])
  @@index([nextDate])
  @@index([userId])
}

model Report {
  id        String     @id @default(cuid())
  userId    String
  name      String
  type      ReportType
  format    String
  startDate DateTime
  endDate   DateTime
  fileUrl   String?
  metadata  Json?
  createdAt DateTime   @default(now())
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([userId])
}

model Revenue {
  id              String            @id @default(cuid())
  amount          Float
  date            DateTime
  kmDriven        Float?
  hoursWorked     Float?
  receiptUrl      String?
  paymentMethodId String?
  driverId        String?
  vehicleId       String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  attachments     Attachment[]
  driver          Driver?           @relation(fields: [driverId], references: [id])
  paymentMethod   PaymentMethod?    @relation(fields: [paymentMethodId], references: [id])
  vehicle         Vehicle?          @relation(fields: [vehicleId], references: [id])
  revenuePlatforms RevenuePlatform[]

  @@index([date, driverId])
  @@index([date, driverId, vehicleId])
  @@index([date])
  @@index([driverId, date])
  @@index([driverId])
  @@index([paymentMethodId, date])
  @@index([vehicleId, date])
  @@index([vehicleId])
}

model RevenuePlatform {
  id         String   @id @default(cuid())
  revenueId  String
  platformId String
  createdAt  DateTime @default(now())
  platform   Platform @relation(fields: [platformId], references: [id], onDelete: Cascade)
  revenue    Revenue  @relation(fields: [revenueId], references: [id], onDelete: Cascade)

  @@unique([revenueId, platformId])
  @@index([platformId])
  @@index([platformId, revenueId])
  @@index([revenueId])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model StripeWebhookEvent {
  id            String   @id @default(cuid())
  stripeEventId String   @unique
  type          String
  processed     Boolean  @default(false)
  createdAt     DateTime @default(now())

  @@index([processed])
  @@index([stripeEventId])
}

model User {
  id                        String                  @id @unique @default(cuid())
  name                      String?
  email                     String?                 @unique
  emailVerified             Boolean?                @default(false)
  picture                   String?
  stripeCustomerId          String?                 @unique @map("stripe_customer_id")
  stripeSubscriptionId      String?                 @unique @map("stripe_subscription_id")
  stripePriceId             String?                 @map("stripe_price_id")
  stripeCurrentPeriodEnd    DateTime?               @map("stripe_current_period_end")
  createdAt                 DateTime                @default(now())
  updatedAt                 DateTime                @updatedAt
  exportCountResetAt        DateTime?
  monthlyExportCount        Int                     @default(0)
  planType                  PlanType                @default(FREE)
  storageUsed               BigInt                  @default(0)
  hasCompletedOnboarding    Boolean                 @default(false)
  cep                       String?
  cpfCnpj                   String?
  phone                     String?
  isGifted                  Boolean                 @default(false)
  alerts                    Alert[]
  attachments               Attachment[]
  budgets                   Budget[]
  drivers                   Driver[]
  emailVerificationCodes    EmailVerificationCode[]
  expenseTemplates          ExpenseTemplate[]
  expenseTypes              ExpenseType[]
  goals                     Goal[]
  insights                  Insight[]
  paymentMethods            PaymentMethod[]
  platforms                 Platform[]
  reminders                 Reminder[]
  reports                   Report[]
  sessions                  Session[]
  preferences               UserPreferences?
  vehicles                  Vehicle[]
}

model UserPreferences {
  id                 String   @id @default(cuid())
  userId             String   @unique
  theme              String   @default("system")
  language           String   @default("en")
  currency           String   @default("brl")
  timezone           String   @default("America/Sao_Paulo")
  use24HourFormat    Boolean  @default(false)
  emailNotifications Boolean  @default(true)
  pushNotifications  Boolean  @default(false)
  marketingEmails    Boolean  @default(false)
  analytics          Boolean  @default(true)
  profileVisibility  Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  defaultDriverId    String?
  defaultVehicleId   String?
  fontFamily         String   @default("default")
  fontSize           String   @default("medium")
  highContrast       Boolean  @default(false)
  keyboardShortcuts  Json?
  lineSpacing        String   @default("normal")
  reducedMotion      Boolean  @default(false)
  country            String   @default("BR")
  driver             Driver?  @relation(fields: [defaultDriverId], references: [id])
  vehicle            Vehicle? @relation(fields: [defaultVehicleId], references: [id])
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Vehicle {
  id              String            @id @default(cuid())
  name            String
  plate           String?
  model           String?
  year            Int?
  userId          String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  isPrimary       Boolean           @default(false)
  expenses        Expense[]
  expenseTemplates ExpenseTemplate[]
  goals           Goal[]
  maintenances    Maintenance[]
  revenues        Revenue[]
  userPreferences UserPreferences[]
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  workLogs        WorkLog[]

  @@index([userId])
  @@index([userId, isPrimary])
}

model WorkLog {
  id          String   @id @default(cuid())
  date        DateTime
  kmDriven    Float
  hoursWorked Float
  driverId    String?
  vehicleId   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  driver      Driver?  @relation(fields: [driverId], references: [id])
  vehicle     Vehicle? @relation(fields: [vehicleId], references: [id])

  @@index([date, driverId, vehicleId])
  @@index([date])
  @@index([driverId])
  @@index([vehicleId])
}

enum AlertType {
  BUDGET_WARNING
  BUDGET_EXCEEDED
  GOAL_PROGRESS
  MAINTENANCE_REMINDER
  EXPENSE_REMINDER
  REVENUE_REMINDER
  DAILY_LOG_REMINDER
}

enum FeeType {
  NONE
  PERCENTAGE
  FIXED
  BOTH
}

enum GoalType {
  DAILY_REVENUE
  WEEKLY_REVENUE
  MONTHLY_REVENUE
  MONTHLY_PROFIT
  MONTHLY_KM
  MONTHLY_HOURS
  CUSTOM
}

enum InsightType {
  COST_INCREASE
  COST_DECREASE
  REVENUE_INCREASE
  REVENUE_DECREASE
  EFFICIENCY_IMPROVED
  EFFICIENCY_DECLINED
  GOAL_ACHIEVED
  BUDGET_EXCEEDED
  MAINTENANCE_DUE
  PATTERN_DETECTED
}

enum PartnerCategory {
  FUEL
  MAINTENANCE
  INSURANCE
  PAYMENT
  PARKING
  TOLLS
  CAR_WASH
  TIRES
}

enum PlanType {
  FREE
  SIMPLE
  PRO
}

enum RecurrenceFrequency {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

enum ReminderFrequency {
  ONCE
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

enum ReportType {
  MONTHLY_SUMMARY
  DRE
  CARNE_LEAO
  EXPENSE_BREAKDOWN
  REVENUE_BREAKDOWN
  DRIVER_PERFORMANCE
  VEHICLE_PERFORMANCE
  CUSTOM
}
