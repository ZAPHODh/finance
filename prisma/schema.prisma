// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DB_PRISMA_URL") // uses connection pooling
  directUrl = env("DB_URL_NON_POOLING") // uses a direct connection
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  expiresAt DateTime
  user      User     @relation(references: [id], fields: [userId], onDelete: Cascade)
}

model EmailVerificationCode {
  id        String   @id @default(cuid())
  code      String
  userId    String
  email     String
  expiresAt DateTime
  user      User     @relation(references: [id], fields: [userId], onDelete: Cascade)
}

model User {
  id                     String                  @id @unique @default(cuid())
  name                   String?
  email                  String?                 @unique
  emailVerified          Boolean?                @default(false)
  picture                String?
  sessions               Session[]
  emailVerificationCodes EmailVerificationCode[]

  stripeCustomerId       String?   @unique @map(name: "stripe_customer_id")
  stripeSubscriptionId   String?   @unique @map(name: "stripe_subscription_id")
  stripePriceId          String?   @map(name: "stripe_price_id")
  stripeCurrentPeriodEnd DateTime? @map(name: "stripe_current_period_end")

  // Subscription limits
  planType          PlanType @default(FREE)
  storageUsed       BigInt   @default(0) // in bytes
  monthlyExportCount Int     @default(0)
  exportCountResetAt DateTime?

  drivers      Driver[]
  vehicles     Vehicle[]
  platforms    Platform[]
  expenseTypes ExpenseType[]
  paymentMethods PaymentMethod[]
  preferences      UserPreferences?
  goals            Goal[]
  budgets          Budget[]
  insights         Insight[]
  alerts           Alert[]
  attachments      Attachment[]
  reports          Report[]
  reminders        Reminder[]
  expenseTemplates ExpenseTemplate[]

  hasCompletedOnboarding Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum PlanType {
  FREE
  SIMPLE
  PRO
}

model Driver {
  id               String            @id @default(cuid())
  name             String
  isSelf           Boolean           @default(false)
  userId           String
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  expenses         Expense[]
  revenues         Revenue[]
  workLogs         WorkLog[]
  goals            Goal[]
  expenseTemplates ExpenseTemplate[]
  defaultForUsers  UserPreferences[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, isSelf])
}

model Vehicle {
  id               String            @id @default(cuid())
  name             String
  plate            String?
  model            String?
  year             Int?
  isPrimary        Boolean           @default(false)
  userId           String
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  expenses         Expense[]
  revenues         Revenue[]
  workLogs         WorkLog[]
  maintenances     Maintenance[]
  goals            Goal[]
  expenseTemplates ExpenseTemplate[]
  defaultForUsers  UserPreferences[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, isPrimary])
}

model Platform {
  id       String    @id @default(cuid())
  name     String
  userId   String
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  revenues RevenuePlatform[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model ExpenseType {
  id               String            @id @default(cuid())
  name             String
  userId           String
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  expenses         ExpenseExpenseType[]
  budgets          Budget[]
  reminders        Reminder[]
  expenseTemplates ExpenseTemplate[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}


enum FeeType {
  NONE
  PERCENTAGE
  FIXED
  BOTH
}

model PaymentMethod {
  id               String            @id @default(cuid())
  name             String
  userId           String
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Fee configuration
  feeType          FeeType           @default(NONE)
  feePercentage    Float?            // Ex: 2.5 for 2.5%
  feeFixed         Float?            // Ex: 0.50 for R$ 0.50

  revenues         Revenue[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

enum RecurrenceFrequency {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

model ExpenseTemplate {
  id              String                @id @default(cuid())
  userId          String
  user            User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  name            String
  amount          Float?

  expenseTypeId   String
  expenseType     ExpenseType           @relation(fields: [expenseTypeId], references: [id], onDelete: Cascade)

  driverId        String?
  driver          Driver?               @relation(fields: [driverId], references: [id], onDelete: SetNull)

  vehicleId       String?
  vehicle         Vehicle?              @relation(fields: [vehicleId], references: [id], onDelete: SetNull)

  // Recurrence
  isRecurring     Boolean               @default(false)
  frequency       RecurrenceFrequency?
  nextDueDate     DateTime?

  isActive        Boolean               @default(true)

  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  @@index([userId, isActive])
  @@index([userId, isRecurring, nextDueDate])
}

model Expense {
  id              String         @id @default(cuid())
  amount          Float
  date            DateTime
  receiptUrl      String?

  expenseTypes    ExpenseExpenseType[]

  driverId        String?
  driver          Driver?        @relation(fields: [driverId], references: [id], onDelete: SetNull)

  vehicleId       String?
  vehicle         Vehicle?       @relation(fields: [vehicleId], references: [id], onDelete: SetNull)

  attachments     Attachment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([driverId])
  @@index([vehicleId])
  @@index([date])
  @@index([driverId, date])
  @@index([vehicleId, date])
  @@index([date, driverId, vehicleId])
}

model Revenue {
  id              String         @id @default(cuid())
  amount          Float
  date            DateTime
  kmDriven        Float?
  hoursWorked     Float?
  receiptUrl      String?

  platforms       RevenuePlatform[]

  paymentMethodId String?
  paymentMethod   PaymentMethod? @relation(fields: [paymentMethodId], references: [id], onDelete: SetNull)

  driverId        String?
  driver          Driver?        @relation(fields: [driverId], references: [id], onDelete: SetNull)

  vehicleId       String?
  vehicle         Vehicle?       @relation(fields: [vehicleId], references: [id], onDelete: SetNull)

  attachments     Attachment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([driverId])
  @@index([vehicleId])
  @@index([date])
  @@index([driverId, date])
  @@index([vehicleId, date])
  @@index([date, driverId])
  @@index([paymentMethodId, date])
  @@index([date, driverId, vehicleId])
}

// Junction table for many-to-many relationship between Revenue and Platform
model RevenuePlatform {
  id         String   @id @default(cuid())
  revenueId  String
  revenue    Revenue  @relation(fields: [revenueId], references: [id], onDelete: Cascade)
  platformId String
  platform   Platform @relation(fields: [platformId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())

  @@unique([revenueId, platformId])
  @@index([revenueId])
  @@index([platformId])
  @@index([platformId, revenueId])
}

// Junction table for many-to-many relationship between Expense and ExpenseType
model ExpenseExpenseType {
  id            String      @id @default(cuid())
  expenseId     String
  expense       Expense     @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  expenseTypeId String
  expenseType   ExpenseType @relation(fields: [expenseTypeId], references: [id], onDelete: Cascade)

  createdAt     DateTime    @default(now())

  @@unique([expenseId, expenseTypeId])
  @@index([expenseId])
  @@index([expenseTypeId])
  @@index([expenseTypeId, expenseId])
}

model WorkLog {
  id           String   @id @default(cuid())
  date         DateTime
  kmDriven     Float
  hoursWorked  Float

  driverId     String?
  driver       Driver?  @relation(fields: [driverId], references: [id], onDelete: SetNull)

  vehicleId    String?
  vehicle      Vehicle? @relation(fields: [vehicleId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([driverId])
  @@index([vehicleId])
  @@index([date])
  @@index([date, driverId, vehicleId])
}

model Maintenance {
  id          String   @id @default(cuid())
  description String
  cost        Float
  date        DateTime
  kmAtService Float?
  nextServiceKm Float?
  receiptUrl  String?

  vehicleId   String
  vehicle     Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  attachments Attachment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([vehicleId])
  @@index([date])
}

model UserPreferences {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Appearance
  theme     String   @default("system") // light, dark, system
  language  String   @default("en") // en, pt

  // Regional
  currency  String   @default("brl") // usd, brl, eur
  timezone  String   @default("America/Sao_Paulo")
  use24HourFormat Boolean @default(false)

  // Notifications
  emailNotifications Boolean @default(true)
  pushNotifications  Boolean @default(false)
  marketingEmails    Boolean @default(false)

  // Privacy
  analytics          Boolean @default(true)
  profileVisibility  Boolean @default(false)

  // Defaults
  defaultDriverId  String?
  defaultDriver    Driver?  @relation(fields: [defaultDriverId], references: [id], onDelete: SetNull)

  defaultVehicleId String?
  defaultVehicle   Vehicle? @relation(fields: [defaultVehicleId], references: [id], onDelete: SetNull)

  // Accessibility
  keyboardShortcuts Json?    // Custom keyboard shortcuts configuration
  fontSize          String   @default("medium") // small, medium, large, x-large
  fontFamily        String   @default("default") // default, dyslexic, mono
  lineSpacing       String   @default("normal") // normal, relaxed, loose
  reducedMotion     Boolean  @default(false)
  highContrast      Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}



enum GoalType {
  DAILY_REVENUE
  WEEKLY_REVENUE
  MONTHLY_REVENUE
  MONTHLY_PROFIT
  MONTHLY_KM
  MONTHLY_HOURS
  CUSTOM
}

model Goal {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String?
  type        GoalType
  targetValue Float
  period      String   // "2025-01" for monthly, "2025-01-15" for daily

  driverId    String?
  driver      Driver?  @relation(fields: [driverId], references: [id], onDelete: SetNull)

  vehicleId   String?
  vehicle     Vehicle? @relation(fields: [vehicleId], references: [id], onDelete: SetNull)

  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([period])
  @@index([driverId])
  @@index([vehicleId])
  // Composite index for goal tracking queries
  @@index([userId, isActive, period])
}

model Budget {
  id              String      @id @default(cuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  name            String?
  expenseTypeId   String
  expenseType     ExpenseType @relation(fields: [expenseTypeId], references: [id], onDelete: Cascade)

  monthlyLimit    Float
  alertThreshold  Float       @default(0.8) // Alert at 80%
  period          String      // "2025-01"

  isActive        Boolean     @default(true)

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([userId])
  @@index([period])
  @@index([expenseTypeId])
  // Composite index for budget alerts
  @@index([userId, isActive, period, expenseTypeId])
}

enum InsightType {
  COST_INCREASE
  COST_DECREASE
  REVENUE_INCREASE
  REVENUE_DECREASE
  EFFICIENCY_IMPROVED
  EFFICIENCY_DECLINED
  GOAL_ACHIEVED
  BUDGET_EXCEEDED
  MAINTENANCE_DUE
  PATTERN_DETECTED
}

model Insight {
  id          String      @id @default(cuid())
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  type        InsightType
  title       String
  description String
  metadata    Json?       // Additional data

  isRead      Boolean     @default(false)
  priority    Int         @default(0) // 0=low, 1=medium, 2=high

  createdAt   DateTime    @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

enum AlertType {
  BUDGET_WARNING
  BUDGET_EXCEEDED
  GOAL_PROGRESS
  MAINTENANCE_REMINDER
  EXPENSE_REMINDER
  REVENUE_REMINDER
  DAILY_LOG_REMINDER
}

model Alert {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  type        AlertType
  title       String
  message     String
  metadata    Json?

  isRead      Boolean   @default(false)
  isSent      Boolean   @default(false)

  createdAt   DateTime  @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([isSent])
}

model Attachment {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  fileName    String
  fileUrl     String
  fileSize    BigInt   // in bytes
  mimeType    String

  expenseId   String?
  expense     Expense? @relation(fields: [expenseId], references: [id], onDelete: Cascade)

  revenueId   String?
  revenue     Revenue? @relation(fields: [revenueId], references: [id], onDelete: Cascade)

  maintenanceId String?
  maintenance   Maintenance? @relation(fields: [maintenanceId], references: [id], onDelete: Cascade)

  metadata    Json?    // OCR data, tags, etc.

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([expenseId])
  @@index([revenueId])
  @@index([maintenanceId])
}

enum ReportType {
  MONTHLY_SUMMARY
  DRE
  CARNE_LEAO
  EXPENSE_BREAKDOWN
  REVENUE_BREAKDOWN
  DRIVER_PERFORMANCE
  VEHICLE_PERFORMANCE
  CUSTOM
}

enum PartnerCategory {
  FUEL
  MAINTENANCE
  INSURANCE
  PAYMENT
  PARKING
  TOLLS
  CAR_WASH
  TIRES
}

model Partner {
  id           String          @id @default(cuid())
  name         String
  category     PartnerCategory
  logoUrl      String?

  // Marketing benefits
  discountRate Float?          // Ex: 15 para 15% de desconto
  tagline      String          // Ex: "Economize até 15% em combustível"
  benefit      String          // Descrição detalhada do benefício
  ctaText      String          // Ex: "Cadastre-se grátis"
  ctaUrl       String          // Link de afiliado/parceiro

  // Targeting
  showForPlans PlanType[]      // [FREE] = só mostra para free tier
  active       Boolean         @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([active])
}

model Report {
  id          String     @id @default(cuid())
  userId      String
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  type        ReportType
  format      String     // pdf, excel, csv

  startDate   DateTime
  endDate     DateTime

  fileUrl     String?
  metadata    Json?

  createdAt   DateTime   @default(now())

  @@index([userId])
  @@index([createdAt])
}

enum ReminderFrequency {
  ONCE
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

model Reminder {
  id          String            @id @default(cuid())
  userId      String
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  title       String
  description String?

  frequency   ReminderFrequency
  nextDate    DateTime

  expenseTypeId String?
  expenseType   ExpenseType? @relation(fields: [expenseTypeId], references: [id], onDelete: SetNull)

  isActive    Boolean   @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([nextDate])
  @@index([isActive])
}

model StripeWebhookEvent {
  id            String   @id @default(cuid())
  stripeEventId String   @unique
  type          String
  processed     Boolean  @default(false)
  createdAt     DateTime @default(now())

  @@index([stripeEventId])
  @@index([processed])
}


